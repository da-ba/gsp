name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build extension
        env:
          GIPHY_API_KEY: ${{ secrets.GIPHY_API_KEY }}
        run: bun run build

      - name: Get version
        id: version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: Prepare demo site
        run: |
          mkdir -p _site
          
          # Copy demo page
          cp demo/index.html _site/
          
          # Copy built content script
          cp dist/content.js _site/
          
          # Create meta.json with build info
          echo "{
            \"version\": \"${{ steps.version.outputs.version }}\",
            \"build\": \"PR#${{ github.event.pull_request.number }}@${GITHUB_SHA:0:7}\",
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"pr\": ${{ github.event.pull_request.number }}
          }" > _site/meta.json

      - name: Upload preview artifact
        uses: actions/upload-artifact@v6
        with:
          name: pr-preview-${{ github.event.pull_request.number }}
          path: _site/
          retention-days: 7

      - name: Comment preview link
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const runId = context.runId;
            const repo = context.repo;
            
            // Read version from package.json
            const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const version = packageJson.version;
            
            const body = `## ðŸŽ¨ Demo Preview Available

            A preview build of this PR is available as an artifact.

            ### How to try it:
            1. Download the [pr-preview-${prNumber}](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}) artifact
            2. Extract and open \`index.html\` in your browser
            3. Try typing \`/gsp\` in the text area

            **Version:** \`${version}\` | **Build:** \`PR#${prNumber}@${context.sha.slice(0, 7)}\`

            ---
            <sub>ðŸ¤– This comment is automatically updated on each push to the PR.</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              ...repo,
              issue_number: prNumber,
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Demo Preview Available')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                ...repo,
                comment_id: existingComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                ...repo,
                issue_number: prNumber,
                body,
              });
            }
