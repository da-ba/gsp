name: Deploy Demo

on:
  # Deploy main on successful CI completion
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]

  # Deploy PRs
  pull_request:
    types: [opened, synchronize, reopened]

  # Allow manual trigger
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pull-requests: write
  deployments: write

# Allow only one concurrent deployment per deployment target
concurrency:
  group: "pages-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'main' }}"
  cancel-in-progress: true

jobs:
  deploy:
    # Run if CI completed successfully, PR event, or manual trigger
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'pull_request' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Checkout gh-pages branch
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Initialize gh-pages if needed
        run: |
          if [ ! -d "gh-pages" ]; then
            mkdir -p gh-pages
          fi

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build extension
        # Build WITHOUT Giphy API key for public demo deployment
        # Users can add their own key via the extension options
        run: bun run build

      - name: Get version
        id: version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: Determine deployment path
        id: deploy-path
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Use the PR head SHA, not the merge commit SHA
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            SHORT_SHA="${HEAD_SHA:0:7}"
            # Flat structure: pr-{NUMBER}-{SHA}
            echo "path=pr-${{ github.event.pull_request.number }}-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "prefix=pr-${{ github.event.pull_request.number }}-" >> $GITHUB_OUTPUT
            echo "build=PR#${{ github.event.pull_request.number }}@${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "environment=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA="${GITHUB_SHA:0:7}"
            # Flat structure: main-{SHA}
            echo "path=main-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "prefix=main-" >> $GITHUB_OUTPUT
            echo "build=main@${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: Prepare deployment
        run: |
          DEPLOY_PATH="${{ steps.deploy-path.outputs.path }}"
          PREFIX="${{ steps.deploy-path.outputs.prefix }}"

          # Remove old deployments with the same prefix (e.g., all old SHAs for this PR or main)
          # Using find with prefix pattern to handle flat structure
          find gh-pages -maxdepth 1 -type d -name "${PREFIX}*" -exec rm -rf {} \; 2>/dev/null || true
          mkdir -p "gh-pages/${DEPLOY_PATH}"
          
          # Copy demo page
          cp demo/index.html "gh-pages/${DEPLOY_PATH}/"
          
          # Copy built content script
          cp dist/content.js "gh-pages/${DEPLOY_PATH}/"
          
          # Create meta.json with build info
          echo "{
            \"version\": \"${{ steps.version.outputs.version }}\",
            \"build\": \"${{ steps.deploy-path.outputs.build }}\",
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"path\": \"${DEPLOY_PATH}\"
          }" > "gh-pages/${DEPLOY_PATH}/meta.json"

      - name: Generate index page
        run: ./scripts/generate-index.sh gh-pages demo/index-template.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          keep_files: false

      - name: Create GitHub Deployment (PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const deployPath = '${{ steps.deploy-path.outputs.path }}';
            const environmentUrl = `https://${repo.owner}.github.io/${repo.repo}/${deployPath}/`;
            const environment = '${{ steps.deploy-path.outputs.environment }}';

            // Deactivate old deployments for this environment first
            const { data: oldDeployments } = await github.rest.repos.listDeployments({
              ...repo,
              environment,
            });

            for (const oldDeployment of oldDeployments) {
              await github.rest.repos.createDeploymentStatus({
                ...repo,
                deployment_id: oldDeployment.id,
                state: 'inactive',
                description: 'Superseded by newer deployment',
              });
            }

            // Create new deployment
            const { data: deployment } = await github.rest.repos.createDeployment({
              ...repo,
              ref: context.payload.pull_request.head.sha,
              environment,
              auto_merge: false,
              required_contexts: [],
              transient_environment: true,
              production_environment: false,
              description: `PR #${{ github.event.pull_request.number }} preview deployment`,
            });

            // Mark deployment as successful with the environment URL
            await github.rest.repos.createDeploymentStatus({
              ...repo,
              deployment_id: deployment.id,
              state: 'success',
              environment_url: environmentUrl,
              log_url: `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${{ github.run_id }}`,
              description: 'Deployment successful',
            });

      - name: Create GitHub Deployment (main)
        if: github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const deployPath = '${{ steps.deploy-path.outputs.path }}';
            const environmentUrl = `https://${repo.owner}.github.io/${repo.repo}/${deployPath}/`;
            const environment = '${{ steps.deploy-path.outputs.environment }}';

            // Deactivate old deployments for production environment first
            const { data: oldDeployments } = await github.rest.repos.listDeployments({
              ...repo,
              environment,
            });

            for (const oldDeployment of oldDeployments) {
              await github.rest.repos.createDeploymentStatus({
                ...repo,
                deployment_id: oldDeployment.id,
                state: 'inactive',
                description: 'Superseded by newer deployment',
              });
            }

            // Create new deployment
            const { data: deployment } = await github.rest.repos.createDeployment({
              ...repo,
              ref: context.sha,
              environment,
              auto_merge: false,
              required_contexts: [],
              transient_environment: false,
              production_environment: true,
              description: 'Main branch deployment',
            });

            // Mark deployment as successful with the environment URL
            await github.rest.repos.createDeploymentStatus({
              ...repo,
              deployment_id: deployment.id,
              state: 'success',
              environment_url: environmentUrl,
              log_url: `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${{ github.run_id }}`,
              description: 'Deployment successful',
            });

      - name: Comment on PR with preview link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo;
            const version = '${{ steps.version.outputs.version }}';
            const deployPath = '${{ steps.deploy-path.outputs.path }}';
            
            const body = `## ðŸŽ¨ Demo Preview Deployed

            A live preview of this PR is available at:
            
            **ðŸ”— [https://${repo.owner}.github.io/${repo.repo}/${deployPath}/](https://${repo.owner}.github.io/${repo.repo}/${deployPath}/)**

            **Version:** \`${version}\` | **Build:** \`PR#${prNumber}@${context.payload.pull_request.head.sha.slice(0, 7)}\`

            ---
            <sub>ðŸ¤– This preview is automatically updated on each push. View all deployments at the [index page](https://${repo.owner}.github.io/${repo.repo}/).</sub>`;

            // Find and delete existing comment
            const { data: comments } = await github.rest.issues.listComments({
              ...repo,
              issue_number: prNumber,
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Demo Preview Deployed')
            );
            
            if (existingComment) {
              await github.rest.issues.deleteComment({
                ...repo,
                comment_id: existingComment.id,
              });
            }
            
            // Create new comment at the bottom
            await github.rest.issues.createComment({
              ...repo,
              issue_number: prNumber,
              body,
            });
